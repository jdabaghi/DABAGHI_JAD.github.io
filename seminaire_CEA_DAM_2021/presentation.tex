

\documentclass[aspectratio=169]{beamer}
\usepackage[utf8]{inputenc}
%\usepackage[latin1]{inputenc}
%\usepackage[cyr]{aeguill}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{amsmath,amsfonts,amsthm,amssymb}
\usepackage{algorithm}
\usepackage{algorithmic}
%\usepackage[]{algorithm2e}
\usepackage{hyperref}
\usepackage{color}
\usepackage{pstricks}
%\usepackage{stmaryrd}
%\usepackage{enumitem} 
\usepackage{bbm}
\usepackage{bm}
\usepackage{array}
\usepackage{relsize,exscale}
\usepackage{caption}
\usepackage{times}
\usepackage{subcaption}
\usepackage{graphicx} 
\usepackage{epstopdf}
\usepackage{tikz}
\usepackage{glossaries}
\usepackage{cancel}
%\usepackage{animate}
\setbeamersize{text margin left=0.2 cm}
  \setbeamersize{text margin right=0.2 cm}
  %\setbeamersize{sidebar width left=}
  %\setbeamersize{sidebar width right=taille}
%\usetikzlibrary{calc}
%\DeclareMathOperator*{\argmin}{argmin}


\definecolor{ao(english)}{rgb}{0.0, 0.5, 0.0}
\definecolor{armygreen}{rgb}{0.29, 0.33, 0.13}
\definecolor{britishracinggreen}{rgb}{0.0, 0.26, 0.15}
\definecolor{cadmiumgreen}{rgb}{0.0, 0.42, 0.24}
\definecolor{indigo}{rgb}{0.29, 0.0, 0.51}
\definecolor{lightgray}{gray}{0.85}
\definecolor{midnightblue}{rgb}{0.1, 0.1, 0.44}
\definecolor{burntorange}{rgb}{0.8, 0.33, 0.0}
\definecolor{royalblue}{rgb}{0.25, 0.41, 0.88}
\definecolor{darkmagenta}{rgb}{0.55, 0.0, 0.55}
\definecolor{byzantine}{rgb}{0.74, 0.2, 0.64}
\definecolor{blue-violet}{rgb}{0.54, 0.17, 0.89}
\definecolor{brown-traditional}{rgb}{0.59, 0.29, 0.0}
\definecolor{brown-web}{rgb}{0.65, 0.16, 0.16}
\definecolor{burgundy}{rgb}{0.5, 0.0, 0.13}
\definecolor{electricpurple}{rgb}{0.75, 0.0, 1.0}
\definecolor{gray}{rgb}{0.5, 0.5, 0.5}
\definecolor{goldenbrown}{rgb}{0.6, 0.4, 0.08}
\definecolor{armygreen}{rgb}{0.29, 0.33, 0.13}
\definecolor{calpolypomonagreen}{rgb}{0.12, 0.3, 0.17}
\definecolor{caputmortuum}{rgb}{0.35, 0.15, 0.13}
\definecolor{carmine}{rgb}{0.59, 0.0, 0.09}
\definecolor{chocolate-traditional}{rgb}{0.48, 0.25, 0.0}
\definecolor{lincolngreen}{rgb}{0.11, 0.35, 0.02}
\definecolor{magenta}{rgb}{1.0, 0.0, 1.0}
\definecolor{auburn}{rgb}{0.43, 0.21, 0.1}
\definecolor{bole}{rgb}{0.47, 0.27, 0.23}
\definecolor{bulgarianrose}{rgb}{0.28, 0.02, 0.03}
%\usepackage[dvipsnames]{xcolor}
%\xdefinecolor{vert_olive}{named}{OliveGreen}
%\xdefinecolor{bleuviolet}{named}{BlueViolet}
%\xdefinecolor{bleucadet}{named}{CadetBlue}
%\xdefinecolor{bleunuit}{named}{MidnightBlue}
\graphicspath{{./Figures/}}
\newtheorem{assumption}[theorem]{Assumption} 
\newtheorem{proposition}[theorem]{Proposition} 
\newtheorem{remark}[theorem]{Remark} 

\renewcommand{\div}{\mathrm{div}}
\newcommand{\Pdot}{\ddot{P}}
\newcommand{\Pdothn}{\Pdot_h^n}
%\usetheme{Madrid}
\usetheme{Frankfurt}

\title[CEA DAM presentation]{A hybrid parareal Monte-Carlo algorithm for parabolic  problems}
\author[Jad Dabaghi]
{\underline{Jad Dabaghi}, Yvon Maday, Andrea Zoia}
\institute[]{CERMICS, \'{E}cole des Ponts ParisTech}
\date{Seminar CEA-DAM, November $22^{\mathrm{nd}}$ $2021$}
\subject{Numerical Analysis}
\input{command}

\setbeamertemplate{navigation symbols}{}
\setbeamercovered{transparent}



\AtBeginSection[] {
    \begin{frame}
    <beamer>[noframenumbering]
        \frametitle{Outline}
        \tableofcontents[currentsection]
    \end{frame}
}


\begin{document}


\begin{frame}
\maketitle
\includegraphics[scale=0.09]{image/Logo_ponts_paristech}
\hfill \includegraphics[scale=0.25]{image/INRIA-SCIENTIFIQUE-UK-RVB}

\end{frame}




\newcommand{\kk}{\textcolor{royalblue}{k}}
\newcommand{\ii}{\textcolor{burntorange}{i}}
\newcommand{\nuu}{\textcolor{burntorange}{\nu}}


\setcounter{tocdepth}{4}
\section{Introduction}

\begin{frame}
\defbeamertemplate*{footline}{infolines theme frame plus slide}{\setcounter{slidenumber}{\insertpagenumber}\addcounter{slidenumber}{-\insertframestartpage}\addcounter{slidenumber}{1}}
\frametitle{Motivation}
  \vspace*{-0.1 cm}
\textcolor{red}{\textbf{Simplified model for neutron transport in nuclear reactors.}}
\invisible<1>{
\begin{equation*}
\text{\textcolor{cadmiumgreen}{\textbf{Boltzmann equation}}}\quad \frac{1}{|v|}\frac{\partial \textcolor{carmine}{\psi}}{\partial t}({\bm r},E,{\bm \Omega},t) + 
\left(\mathcal{A}-\mathcal{S}-\mathcal{F}\right)\textcolor{carmine}{\psi}({\bm r},E,{\bm \Omega},t) = Q(\br, {\bm \Omega},E,t)
\end{equation*}
\textcolor{midnightblue}{\textbf{Monte Carlo simulation}}
\textcolor{burntorange}{\footnotesize{Lux $\&$ Koblinger (1991)}}
\\
\vspace*{0.15 cm}
$\textcolor{red}{\rightarrow}$ intrinsically parallel
 : one replica $\iff$ one processor
\\
\vspace*{0.15 cm}
$\textcolor{red}{\rightarrow}$ preferred in large dimension
\\
\vspace{0.2 cm}
\invisible<2>{
\begin{minipage}{.5 \textwidth}
  \textcolor{midnightblue}{\textbf{Can we speed-up a Monte Carlo resolution?}}
  \\ 
  $\textcolor{red}{\rightarrow}$ time parallelization  \\\\
\textcolor{cadmiumgreen}{\textbf{Very complicated model:}} Start with a diffusion problem to understand the involved underlying mechanisms.
%$\textcolor{carmine}{\psi}$ : flux angulaire \\
%$\mathcal{A}$ : opérateur d'advection \\
%$\mathcal{S}$ : opérateur de scattering \\
%$\mathcal{F}$ : opérateur de fission
\end{minipage}
\hfill
\begin{minipage}{.48 \textwidth}
\hspace*{1 cm}
\includegraphics[width= 0.73 \textwidth]{image/reactor}
\end{minipage}
\invisible<3>{
}}}
\end{frame}

\section{Parareal algorithm}
    
\subsection{}  

\begin{frame}
\frametitle{Model problem}
\textcolor{cadmiumgreen}{\textbf{Time-dependent diffusion equation with dirichlet boundary conditions:}}
\begin{equation*}
\dps
\left\lbrace\begin{array}{llccc}
\dps \partial_t u - \mathcal{D} \Delta u = 0 \quad & \mbox{in} \quad &\Omega \times \left[0,T\right], \\
 \dps u({\bm \cdot},0) = u^0 \quad & \mbox{in} \quad &\Omega,\\
u = 0 \quad & \mbox{on} \quad &\partial \Omega \times [0,T] . 
\end{array}
\right.
\end{equation*}
\invisible<1>{
  \textcolor{midnightblue}{\textbf{Weak formulation:}} Find $u \in H_0^1(\Omega)$ such that
  \begin{equation*}
\left \langle \partial_t u, v \right \rangle_{H^{-1}(\Omega), H_0^1(\Omega)} + \mathcal{D} \int_{\Omega} \nab u \cdot \nab v \,\mathrm{dx} = 0 \quad \forall v \in H_0^1(\Omega) \quad \text{  \textcolor{midnightblue}{Well-posed problem}}
  \end{equation*}
  \textcolor{burntorange}{\footnotesize{Lions (1969), Dautrey \& Lions (1985), Brezis (2011)}}
  \invisible<2>{
    }}
\end{frame}
%
\begin{frame}
  \frametitle{Parareal algorithm}
  \vspace*{-0.2 cm}
  \textcolor{red}{\textbf{Parallelization of the time variable !}}
  \textcolor{burntorange}{\footnotesize{Lions, Maday, Turinici (2001)}}

\invisible<1>{

\begin{itemize}
\item Coarse sequential propagator $\mathcal{G}$ with associated time step $\textcolor{blue}{\Delta t}$

\item Fine parallel propagator $\mathcal{F}$ with associated time step $\textcolor{red}{\delta t}$, so that $\textcolor{red}{\delta t} \ll \textcolor{blue}{\Delta t}$
  
  \begin{figure}
\includegraphics[scale = 0.45]{image/discretization_time_coarse_fine-cropped}
  \end{figure}
  \invisible<2>{
  \item Initialization : Compute a coarse solution at each time step $n$
    \begin{equation*}
\bU_{\kk=0}^{n+1} := \mathcal{G}_{\Delta T}(\bU_{\kk=0}^n), \quad \text{with} \quad \bU_{\kk=0}^0 = \bU^{0} \qquad \kk : \  \text{parareal iteration}
    \end{equation*}
    \vspace{-0.3 cm}
    \invisible<3>{
    \item
    Compute parallel propagations: $\mathcal{F}_{\Delta T}(\bU_{\kk}^n) \ \ \forall n=0\cdots \Nt-1$
    \invisible<4>{
      \item Parareal updates
    \begin{equation*}
\boxed{\bU_k^n \approx u(t_n)} \qquad \bU_{\kk + 1}^{n+1} := \underbrace{\mathcal{G}_{\Delta T}(\bU_{\kk + 1}^n)}_{\text{prediction}} + \underbrace{\mathcal{F}_{\Delta T}(\bU_{\kk}^n) - \mathcal{G}_{\Delta T}(\bU_{\kk}^n)}_{\text{correction}} \quad \text{with} \quad \bU_{\kk+1}^0 := \bU^0
      \end{equation*}
  \end{itemize}
  \invisible<5>{
    }}}}}
  \end{frame}
%
\begin{frame}
  \frametitle{Illustration of the procedure $n=3$ and $k=2$} 
%% \begin{equation*}
%%   \begin{split}
%%     u_{\kk=0}^{n+1} & := \mathcal{G}_{\Delta T}(u_{\kk=0}^n), \qquad \text{where} \quad u_{\kk=0}^0 := u^0. \\
%%     u_{\kk+1}^{n+1} & := \underbrace{\mathcal{G}_{\Delta T}(u_{\kk+1}^n)}_{\mathrm{prediction}} + \underbrace{\left[\mathcal{F}_{\Delta T}(u_{\kk}^n) - \mathcal{G}_{\Delta T}(u_{\kk}^n) \right]}_{\mathrm{correction}}.
%%     \end{split}
%% \end{equation*}
\invisible<1>{
\begin{enumerate}
\item  Compute coarse approximations: $u_{\kk=0}^{1}, \quad u_{\kk=0}^{2}, \quad u_{\kk=0}^{3}$
\invisible<2>{
  \item  Compute in parallel:
\begin{equation*}
  \FDT(u_{\kk=0}^0) - \GDT(u_{\kk=0}^0), \ \FDT(u_{\kk=0}^1) - \GDT(u_{\kk=0}^1), \ \FDT(u_{\kk=0}^2) - \GDT(u_{\kk=0}^2)
\end{equation*}
\\
\invisible<3>{
\item Compute the prediction $\GDT(u_{\kk=1}^0)$  
\invisible<4>{
\item \textcolor{cadmiumgreen}{\textbf{Update:}} $\fbox{$u_{\kk=1}^1$} \ \text{and} \ \GDT(u_{\kk=1}^1), \ \fbox{$u_{\kk=1}^2$} \ \text{and} \ \GDT(u_{\kk=1}^2), \ \fbox{$u_{\kk=1}^3$}$
\\
\vspace*{0.1 cm}
\invisible<5>{
\item Compute in parallel:
\begin{equation*}
\FDT(u_{\kk=1}^1) - \GDT(u_{\kk=1}^1), \quad \FDT(u_{\kk=1}^2) - \GDT(u_{\kk=1}^2), \quad \FDT(u_{\kk=1}^3) - \GDT(u_{\kk=1}^3)
\end{equation*}
\\
\invisible<6>{
  \item
Compute the prediction $\GDT(u_{k=2}^0)$
\invisible<7>{
  \item \textcolor{cadmiumgreen}{\textbf{Update:}} 
    $ \fbox{$u_{\kk=2}^1$} \quad \text{and} \quad \GDT(u_{\kk=2}^1) \quad \fbox{$u_{\kk=2}^2$} \quad \text{and} \quad \GDT(u_{\kk=2}^2) \quad \fbox{$u_{\kk=2}^3$}$
    \end{enumerate}
\invisible<8>{
  }}}}}}}}
\end{frame}
%
\begin{frame}
  \frametitle{Some remarks on parareal}
  \begin{enumerate}
  \item
    In general the two solvers are deterministic
    \vspace{0.2 cm}
  \item
    Parareal converges for parabolic problems \textcolor{burntorange}{\footnotesize{Gander, Vandewalle (2007)}}
    \vspace{0.2 cm}
  \item
    Instability observed for hyperbolic problems \textcolor{burntorange}{\footnotesize{Gander (2008)}} 
  \end{enumerate}
  \vspace*{0.2 cm}
  \textcolor{red}{Goal: Construct a hybrid parareal Monte Carlo algorithm for parabolic problems}
  \end{frame}
\section{Coarse and fine propagator}
\begin{frame}
  \frametitle{Coarse propagator}
  \vspace*{-0.1 cm}
  $\Th$: mesh of the domain $\Omega$\\
  \vspace{0.15 cm}
  $\Vh$ : Lagrange nodes, $\Vhint$: interior nodes, \\
  \vspace{0.15 cm}
  $\Nhint$ : number of internal Lagrange nodes, \ $\Ne$ : number of elements \\
  \vspace*{0.15 cm}
\invisible<1>{
  \textcolor{midnightblue}{\textbf{The finite element propagator}}
  \begin{equation*}
    \begin{split}
X_h^p &:= \left\{v_h \in \mathcal{C}^{0}(\Omega); v_h|_{K} \in \mathbb{P}_p(K) \ \forall K \in \Th \right\} \subset H^1(\Omega) \\
X_{0h}^p & := \left\{v_h \in \mathcal{C}^{0}(\Omega); v_h|_{K} \in \mathbb{P}_p(K) \ \forall K \in \Th, \ v_h|_{\partial \Omega}=0 \right\} \subset H_{0}^1(\Omega)
\end{split}
  \end{equation*}
  \invisible<2>{
  The discrete vector of unknowns : $\bU_h^n \in \mathbb{R}^{\Nhint}$ satisfies $\bU_h^n = \GDt(\bU_h^{n-1})$ with
  \begin{equation*}
    \GDt(\bU_h^{n-1}) = [\mathbb{A}^n]^{-1}  \times \bF^{n-1}, \quad \underbrace{[\mathbb{A}^n]^{-1}}_{\mathrm{Stiffness} \ \mathrm{matrix} + \mathrm{mass} \ \mathrm{matrix}} \hspace{-0.6 cm} \in \mathbb{R}^{\Nhint,\Nhint}, \quad \bF^{n-1} \in \mathbb{R}^{\Nhint}
  \end{equation*}
  \invisible<3>{
    }}}
  \end{frame}
%
\begin{frame}
\textcolor{midnightblue}{\textbf{The cell centered finite volume propagator}}
  \begin{equation*}
\bU_h^n \egaldef (\bU_K^n)_{K\in \Th}, \quad \textcolor{cadmiumgreen}{\textbf{one value per cell and time step}} 
\end{equation*}
  The discrete vector of unknowns : $\bU_h^n \in \mathbb{R}^{\Ne}$ satisfies $\bU_h^n = \GDt(\bU_h^{n-1})$ with
  \begin{equation*}
    \GDt(\bU_h^{n-1}) = [\mathbb{A}^n]^{-1}  \times \bF^{n-1}, \quad \underbrace{[\mathbb{A}^n]^{-1}}_{\mathrm{Sparse}} \in \mathbb{R}^{\Ne,\Ne}, \quad \bF^{n-1} \in \mathbb{R}^{\Ne}
  \end{equation*}
\end{frame}
%
\begin{frame}
  \textcolor{midnightblue}{\textbf{The discontinuous Galerkin propagator}}
  \\
  \vspace*{0.2 cm}
  $\Nhint$:  total number of local internal degrees of freedom.
  \\
  \vspace*{0.2 cm}
  \textcolor{cadmiumgreen}{\textbf{Discontinuous Galerkin space:}}
  \begin{equation*}
    \begin{split}
      X_h^p & := \left\{v_h \in L^2(\Omega); v_h|_{K} \in \Pp(K) \ \forall K \in \Th  \right\} \not \subset H^1(\Omega),\\
X_{0h}^p & := \left\{v_h \in L^2(\Omega); v_h|_{K} \in \Pp(K) \ \forall K \in \Th, v_h|_{\partial \Omega} = 0  \right\} \not \subset H_0^1(\Omega)
    \end{split}
  \end{equation*}
  The discrete vector of unknowns : $\bU_h^n \in \mathbb{R}^{\Nhint}$ satisfies $\bU_h^n = \GDt(\bU_h^{n-1})$ with
  \begin{equation*}
    \GDt(\bU_h^{n-1}) = [\mathbb{A}^n]^{-1}  \times \bF^{n-1}, \quad [\mathbb{A}^n]^{-1} \in \mathbb{R}^{\Nhint,\Nhint}, \quad \bF^{n-1} \in \mathbb{R}^{\Nhint}
  \end{equation*}
  \textcolor{cadmiumgreen}{\textbf{local matrix}} $[\mathbb{A}^n]^{-1}_K = $ stiffness matrix $+$ mass matrix $+$ consistency and stability terms.
\end{frame}
%
\begin{frame}
  \frametitle{Fine propagator : Monte-Carlo}
  \textcolor{cadmiumgreen}{\textbf{Principle:}}
  It gives an approximation of
  \begin{equation*}
    \int_K u(\bx)\,\mathrm{d}\bx = \int_K \underbrace{f}_{PDF}(\bx) g(\bx)\,\mathrm{d}\bx.
  \end{equation*}
  \invisible<1>{
    Consider $M$ particles and sample a collection $X_1, X_2, \cdots, X_M$ of $M$ points from the PDF $f$. Denote by $\omega_i \in \mathbb{R}_{+}$ their statistical weight.
    \\
    \vspace*{0.2 cm}
    Compute $g(X_1)$,...,$g(X_M)$.
    \\
    \vspace*{0.1 cm}
  \begin{equation*}
\int_K u(\bx)\,\mathrm{dx} = \overline{\mathbb{E}}\left[g(\bx)\right].
  \end{equation*}
    \\
    \vspace{0.1 cm}
    \invisible<2>{
  \textcolor{cadmiumgreen}{\textbf{Law of large numbers:}} $\dps \lim_{M \rightarrow + \infty} \frac{1}{M} \sum_{i=1}^M g(X_i) = \int_K u(\bx)\,\mathrm{d} \bx$.
  \invisible<3>{
        \\
    \vspace{0.1 cm}
  \textcolor{cadmiumgreen}{\textbf{Central limit Theorem:}}
\vspace*{-0.15 cm}
  \begin{equation*}
    \mathrm{error} \approx 1/\sqrt{M}.
  \end{equation*}
  \invisible<4>{
    }}}}
\end{frame}
%
\begin{frame}
\frametitle{Sampling in 1D}
  \textcolor{cadmiumgreen}{\textbf{Direct inversion of the cumulative for a given PDF:}}
  \\
  \vspace*{0.2 cm}
  \invisible<1>{
$F : \Omega \rightarrow [0,1] \hspace{0.15 cm}$ such that $F(x) := \int_{- \infty}^{x} f(u)\,\mathrm{d}u$.
    \\ \vspace*{0.2 cm}
    Let $\xi_1 \sim \mathcal{U}([0,1])$. Position of the particle: ${X}_i=F^{-1}(\xi_1)$.
    \\ \vspace*{0.2 cm}
    Repeat $M$ times the procedure.
    \\
    \vspace*{0.3 cm}
    \invisible<2>{
    \textcolor{cadmiumgreen}{\textbf{The table lookup method:}}
    \\
    \vspace*{0.2 cm}
    Probability each element: $\mathbb{P}([x_{i-1},x_{i}]) = \int_{[x_{i-1},x_{i}]} f(x)\,\mathrm{d} x$,\\
    \vspace*{0.2 cm}
    Cumulative function: $F_{i}: \Omega \rightarrow [0,1], \ F_{i} = \sum_{j \leq i} \mathbb{P}([x_{j-1},x_{j}])$
    \\
    \vspace*{0.2 cm}      
    Let $\xi_1 \sim \mathcal{U}([0,1])$. Identify the two intervals such that $F_{i-1} \leq \xi_1 \leq F_{i}$. 
    \\
    \vspace*{0.2 cm}    
    Position of the particle: $\dps {X}_i = \frac{\left(x_i - x_{i-1}\right) \xi_1 - x_i F_{i-1} + x_{i-1} F_i}{F_i-F_{i-1}}$.
        \\ \vspace*{0.2 cm}
        Repeat $M$ times the procedure.
        \invisible<3>{
          }}}
\end{frame}
%
%% \begin{frame}
%%   \vspace{0.3 cm}
%%     \textcolor{cadmiumgreen}{\textbf{Rejection method:}}
%%     \\
%%     \vspace{0.1 cm}
%%     Often used when the PDF $f$ is hard to invert. Assume there exists a PDF $g : \Omega \rightarrow \mathbb{R}_{+}$ ``easy'' to simulate such that
%%     \begin{equation*}
%% f(x) \leq k g(x), \quad \text{where} \quad k \geq 1 \quad \text{is a constant}. 
%%       \end{equation*}
%%     Set $\dps \alpha(x)=\frac{f(x)}{k g(x)}$.
%%     \\
%%     \vspace*{0.2 cm}
%%     Compute the cumulative function $G:\Omega \rightarrow [0,1]$ associated to $g$.\\
%%     \vspace*{0.2 cm}
%%     Let $\xi \sim \mathcal{U}([0,1])$. \\
%%     \vspace*{0.2 cm}
%%     Find ${X}_i \in K$ using the direct inversion procedure.    \\
%%     \vspace*{0.2 cm}
%%     Compute $\alpha({X}_i)$.
%%     \\
%%     \vspace*{0.2 cm}
%%     Let $\xi_1 \sim \mathcal{U}([0,1])$. If $\xi_1 \leq \alpha ({X}_i)$ accept ${X}_i$. Otherwise reject and and come back to first step.
%%     \\
%%     \vspace*{0.3 cm}
%%     \textcolor{red}{\textbf{How define the transport of the particles?}}
%% \end{frame}
%
\begin{frame}
  \frametitle{Kernel Transport}
  $(\bx,t)$ : position of the particle $\bx$ at time $t$,   $(\bx^{\prime},t^{\prime})$ : position of the particle $\bx^{\prime}$ at time $t^{\prime}$
  \\
  \vspace*{0.2 cm}
  Density transition kernel:
  \begin{equation*}
    T(\bx^{\prime},t^{\prime} \rightarrow \bx,t) :=
    \frac{1}{\sqrt{2 \pi \mathcal{D} \left(t-t^{\prime}\right)}}
    \exp \left(-\frac{(\bx-\bx^{\prime})^2}{2 \mathcal{D} \left(t-t^{\prime}\right)}\right).
  \end{equation*}
  %% \begin{equation*}
  %%   \bx - \bx^{\prime} \sim \mathcal{N}(\bx^{\prime}, \mathcal{D} (t-t^{\prime}))
  %% \end{equation*}
  \textcolor{cadmiumgreen}{\textbf{Pratical formula for the brownian motion:}}
  \begin{equation*}
T({\bm X}^{n+\delta t}, t^{n} + \delta t) = T({\bm X}^{n},t^{n}) + \sqrt{2 \mathcal{D} \delta t} \ \mathcal{S}_n \quad \text{where} \quad \mathcal{S}_n \sim \mathcal{N}(0,1)
    \end{equation*}
  \begin{figure}
    \centering
\includegraphics[scale=0.33]{image/Sampling_2D-cropped}
    \end{figure}
\end{frame}
%
\section{Hybrid parareal algorithm}
\begin{frame}
  \frametitle{Hybrid parareal algorithm}
  \textcolor{red}{\textbf{Philosophy of the present work}}
  \\
  \vspace*{0.15 cm}
  Assume that $1000$ processors are available.
  \\
  \vspace*{0.15 cm}
\textcolor{midnightblue}{\textbf{Monte Carlo :}}  We simulate $10^6$ particules per processor. Precision : $1/\sqrt{10^9}$
\\
\vspace*{0.2 cm}
\textcolor{cadmiumgreen}{\textbf{1 replica = 1 processor}}
\\
\vspace*{0.2 cm}
\begin{minipage}{0.6 \textwidth}
\begin{figure}
\includegraphics[scale=0.42]{image/image_MC-cropped}
\end{figure}
\end{minipage}
\hfill
\begin{minipage}{0.38 \textwidth}
  Required time for the propagation over a window $\Delta T$: $\mathcal{F}_{\Delta T} = T/4$ seconds.
  \\\\
Total required time for each replica $=T$ seconds $\Rightarrow$ total time $ \approx T$ secondes.
\end{minipage}
\textcolor{midnightblue}{Assume now that $4000$ processors are available.}
\\
\vspace{0.15 cm}
\textcolor{red}{precision: $1/\sqrt{4 \times 10^{9}}$ but statistical precision was already achieved... }
\end{frame}

\begin{frame}[noframenumbering]
\textcolor{midnightblue}{\textbf{Parareal :}} We employ the excess processors to parallelize the time variable !
\\
\vspace*{0.2 cm}
\begin{itemize}
\item \textcolor{cadmiumgreen}{\textbf{$4$ processors allocated to the time parallelization}}
\vspace*{0.2 cm}
\item For each time observable we have $1000$ processors.
  For each of these processors we simulate $10^6$ particles.
\end{itemize}
\begin{minipage}{0.7 \textwidth}
\begin{figure}
  \centering
\includegraphics[scale = 0.42]{image/time_parallelization}
\end{figure}
\end{minipage}
\hfill
\begin{minipage}{0.29 \textwidth}
  \textcolor{cadmiumgreen}{\textbf{Precision :}}
  \begin{equation*}
    \frac{1}{\sqrt{10^9}}
    \end{equation*}
  \\\\
%  \vspace*{0.4 cm}
  \textcolor{cadmiumgreen}{\textbf{CPU cost :}}
  \\
  \begin{equation*}
    \widetilde{T} = \frac{T}{4} \times \overline{k} \quad \text{with} \quad \overline{k} < 4
    \end{equation*}
  \end{minipage}
%% \vspace*{0.2 cm}
%% \textcolor{red}{\textbf{$1^{\mathrm{er}}$ scénario :}} 
%% \\
%% \vspace*{0.2 cm}
%% On peut utiliser $10^7/93 > 10^5$ particules par processeurs mais le temps de propagation sur la fenêtre $[T_n,T_{n+1}]$ sera plus grand que $\dps T/7$ secondes.
%% \\
%% \vspace*{0.2 cm}
%% \begin{minipage}{.1 \textwidth}
%% \begin{figure}
%% \includegraphics[scale=0.03]{attention}
%% \end{figure}
%% \end{minipage}
%% \hfill
%% \begin{minipage}{.89 \textwidth}
%% Pour des temps longs et plusieurs fenêtres pararéelles on peut obtenir $\tilde{T} > T$.
%% \end{minipage}
%% \\
%% \vspace*{0.4 cm}
%% \textcolor{red}{\textbf{$2^{\mathrm{nd}}$ scénario :}}
%% \\
%% \vspace*{0.2 cm}
%% Diminution du nombre de particules par processeurs ($10^5$) pour avoir $T/7 = \tilde{T}/7$.
%% \\
%% \vspace*{0.2 cm} 
\begin{center}
 \textcolor{red}{Other possibility: simulate a Borwnian motion on an interval $\dps \left[0, \frac{4}{\overline{k}} T \right]$.}
  \end{center}
\end{frame}

\begin{frame}
  \frametitle{The hybrid algorithm}
  \begin{itemize}
  \item
    \textcolor{midnightblue}{\textbf{Coarse propagator :}} Deterministic solver
  \item
\textcolor{midnightblue}{\textbf{Fine propagator:}} Monte-Carlo solver: deterministic data $+$ sampling $+$ average    
    \end{itemize}
\vspace*{0.2 cm}
The numerical solution obtained for a replica $j \in \left[1, p\right]$ at parareal iteration $\kk$ is denoted by ${\bm U}_{\kk,j}^{n+1}$
\begin{equation*}
{\bm U}_{\kk}^{n+1} := \frac{1}{p} \sum_{j=1}^p {\bm U}_{\kk,j}^{n+1}
\end{equation*}
\begin{minipage}{0.2 \linewidth}
\begin{figure}
\includegraphics[scale=0.04]{image/attention}
\end{figure}
\end{minipage}
\hfill
\begin{minipage}{0.75 \linewidth}
  When ${\bm U}_{\kk,j}^{n+1}$ is computed, we need its statistical version for the computation of ${\bm U}_{\kk+1,j}^{n+2} = \GDT({\bm U}_{\kk+1,j}^{n+1}) \times \dps \frac{\textcolor{red}{\FDT({\bm U}_{\kk,j}^{n+1})}}{\GDT({\bm U}_{\kk,j}^{n+1})}$.
  Introduce bias in the Monte-Carlo solver.
\end{minipage}
\end{frame}
%
\begin{frame}
  \frametitle{Updating the statistical weights}
  \textcolor{cadmiumgreen}{\textbf{Example:}} How avoid sampling ${\bm U}_{\kk=2}^3 = \GDT(U_{\kk=2}^2) \times \frac{\FDT({\bm U}_{\kk=1}^2)}{\GDT({\bm U}_{\kk=1}^2)}$ ?
  We consider the statistical representation $\widetilde{\FDT}({\bm U}_{\kk=1}^2)$ before the average and we modify each of its particle weigths.
  \begin{equation*}
[\omega_{\kk=2}^3]_{i\in K} = [\omega_{\widetilde{\FDT}({\bm U}_{\kk=1}^2)}]_{i \in K} \times \left(\frac{{\bm U}_{\kk=2}^3}{\FDT({\bm U}_{\kk=1}^2)} \right)|_{K}
    \end{equation*}
  \begin{figure}
    \centering
    \includegraphics[scale=0.6]{image/reweighting}
  \end{figure}
  \end{frame}

%
\section{Numerical experiments}
\subsection{}
\begin{frame}
\frametitle{Numerical experiments}
\textbf{Final simulation time:} $T=10 s$. \textbf{Diffusion coefficient:} $\mathcal{D} = 0.5 m^2 \cdot s^{-1}$.
\\
\vspace{0.2 cm}
\textbf{Coarse propagator:} $\mathbb{P}_1$ FEM, $\Delta t = 2 s$, \textbf{Fine propagator:} Monte-Carlo, $\delta t = 2 \times 10^{-4} s$.
\\
\vspace{0.2 cm}
\textbf{Initial condition:} $u_0(x)=\frac{1}{L}$, \textbf{Number of particles:} $10^4$, \textbf{Number of replicas:} $10^3$
\\
\vspace{0.1 cm}
\begin{figure}
  \centering
  \includegraphics[width= 0.43 \textwidth]{image/Full_MC_coarse_FEM_n=8}
  \quad
  \includegraphics[width= 0.43 \textwidth]{image/Full_MC_coarse_FEM_n=10}
\end{figure}
\end{frame}
%
\begin{frame}
\frametitle{Hybrid solution}
  \begin{figure}
\centering
\includegraphics[width=0.49\textwidth]{image/Coarse_solution_vs_hybrid_n=5}
\includegraphics[width=0.49\textwidth]{image/hybrid_sol_MC_error_bar_zoom_bis} 
\end{figure}
\end{frame}
%
\begin{frame}
 \frametitle{CPU time and convergence}
\vspace*{-0.3 cm}
%%  \begin{figure}
%% \centering
%% \includegraphics[width=0.48\textwidth]{image/CPU_time_hybrid_vs_MC}
%% \includegraphics[width=0.5\textwidth]{image/Linf_error}
%% \end{figure}
\begin{table}[]
\centering
\begin{tabular}{|ccccccc|}
\hline
\multicolumn{7}{|c|}{Hybrid parareal resolution}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      \\ \hline
\multicolumn{1}{|c|}{\begin{tabular}[c]{@{}c@{}}Number \\ of\\ processors\\ time parallelization\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Number \\ of\\ replicas for each\\ parallel-in-time\\ propagation\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Number \\ of\\ particles \\ for one\\ replica $j$\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}CPU \\ time\\ $k=1$\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}CPU \\ time\\ $k=2$\end{tabular}} & \multicolumn{1}{c|}{\begin{tabular}[c]{@{}c@{}}Gain \\ factor\\ $k=1$\end{tabular}} & \begin{tabular}[c]{@{}c@{}}Gain \\ factor\\ $k=2$\end{tabular} \\ \hline
\multicolumn{1}{|c|}{$5$}                                                                                   & \multicolumn{1}{c|}{$10^2$}                                                                                        & \multicolumn{1}{c|}{$10^5$}                                                                              & \multicolumn{1}{c|}{$335.76$ s}                                               & \multicolumn{1}{c|}{$537.16$ s}                                               & \multicolumn{1}{c|}{$4.92$}                                                      & $3.04$                                                      \\ \hline
\multicolumn{1}{|c|}{$5$}                                                                                   & \multicolumn{1}{c|}{$10^3$}                                                                                        & \multicolumn{1}{c|}{$10^4$}                                                                              & \multicolumn{1}{c|}{$33.05$ s}                                                & \multicolumn{1}{c|}{$53.1$ s}                                                 & \multicolumn{1}{c|}{$4.96$}                                                      & $3.09$                                                      \\ \hline
\multicolumn{1}{|c|}{$5$}                                                                                   & \multicolumn{1}{c|}{$10^4$}                                                                                        & \multicolumn{1}{c|}{$10^3$}                                                                              & \multicolumn{1}{c|}{$3.39$ s}                                                 & \multicolumn{1}{c|}{$5.49$ s}                                                 & \multicolumn{1}{c|}{$4.97$}                                                      & $3.07$                                                      \\ \hline
\multicolumn{1}{|c|}{$5$}                                                                                   & \multicolumn{1}{c|}{$10^5$}                                                                                        & \multicolumn{1}{c|}{$10^2$}                                                                              & \multicolumn{1}{c|}{$0.35$ s}                                                 & \multicolumn{1}{c|}{$0.58$ s}                                                 & \multicolumn{1}{c|}{$5.08$}                                                      & $3.02$                                                      \\ \hline
\end{tabular}
\end{table}
\end{frame}
%
\begin{frame}
  \frametitle{A second test case}
  \textbf{Final simulation time:} $T=14 s$.
\\
\vspace{0.3 cm}
\textbf{Deterministic propagator:} $\mathbb{P}_1$ finite element, $\Delta t = 2 s$.
\\
\vspace{0.3 cm}
\textbf{Fine propagator:} Monte-Carlo, $\delta t = 2 \times 10^{-4} s$.
\\
\vspace{0.3 cm}
\textbf{Diffusion coefficient MC:} $\mathcal{D} = 0.5 m^2 \cdot s^{-1}$
\\
\vspace{0.3 cm}
\textbf{Diffusion coefficient FEM:} $\mathcal{D}=0.48 m^2 \cdot s^{-1}$
\\
\vspace{0.3 cm}
\textbf{Initial condition:} $\dps u_0(x)=\frac{1}{L} \left(1 + \cos(\frac{\pi x}{L}) \right)$.
\\
\vspace{0.3 cm}
\textbf{Number of particles:} $10^5$, \textbf{Number of replicas:} $10^2$
\end{frame}
%
\begin{frame}
  \frametitle{CPU time and convergence}
  \begin{figure}
\centering
\includegraphics[width=0.49\textwidth]{image/sol_k1_k2_zoom}
\includegraphics[width=0.5\textwidth]{image/CPU_time_trigo}
\end{figure}
\end{frame}
%
\begin{frame}
  \frametitle{A third test case}
  \textbf{Final simulation time:} $T=50 s$.
\\
\vspace{0.3 cm}
\textbf{Deterministic propagator:} $\mathbb{P}_1$ finite element, $\Delta t = 2 s$.
\\
\vspace{0.3 cm}
\textbf{Fine propagator:} Monte-Carlo, $\delta t = 2 \times 10^{-3} s$.
\\
\vspace{0.3 cm}
\textbf{Diffusion coefficient MC:} $\mathcal{D} = 0.25 m^2 \cdot s^{-1}$
\\
\vspace{0.3 cm}
\textbf{Diffusion coefficient FEM:} $\mathcal{D}=0.25 m^2 \cdot s^{-1}$
\\
\vspace{0.3 cm}
\textbf{Initial condition:} $\dps u_0(x)=\frac{1}{L}$.
\\
\vspace{0.3 cm}
\textbf{Number of particles:} $10^5$, \textbf{Number of replicas:} $10^3$
\end{frame}
\begin{frame}
\frametitle{Convergence}
  \begin{figure}[H]
\centering
\includegraphics[width = 0.49 \textwidth]{image/Solution_n25bis}
\quad
\includegraphics[width = 0.47 \textwidth]{image/parareal_cv_n_25}
\end{figure}
\end{frame}
%
\begin{frame}
\frametitle{Simulate longer times}
  \begin{figure}
    \centering
\includegraphics[width = 0.48 \textwidth]{image/CPU_hyb_long_time}
\quad
\includegraphics[width = 0.48 \textwidth]{image/para_iter_hyb_long_time}
\end{figure}
\begin{thebibliography}{10}
 \scriptsize{
 \bibitem{Dabaghi:Maday:Zoia:2020}
 {\sc J.~Dabaghi, Y.~Maday, A.~Zoia, {\em A hybrid parareal Monte-Carlo algorithm for parabolic problems}.
 \textcolor{black}{In revision (2021)}}}
 \end{thebibliography}
\end{frame}
\section{Extension to the Boltzmann equation}
\begin{frame}
  \frametitle{Model problem}
  \textcolor{midnightblue}{\textbf{monokinetic 1D Boltzmann model}}
  \begin{equation*}
  \begin{split}
    & \frac{\partial \psi_{+}}{\partial t} (x,t) + \frac{\partial \psi_{+}}{\partial x} (x,t) + \Sigma_{t} \psi_{+}(x,t) = \left(\frac{\Sigma_s}{2} + \nu \frac{\Sigma_f}{2}\right) \left(\psi_{+}(x,t) + \psi_{-}(x,t)\right)  \\
    & \frac{\partial \psi_{-}}{\partial t} (x,t) - \frac{\partial \psi_{-}}{\partial x} (x,t) + \Sigma_{t} \psi_{-}(x,t) = \left(\frac{\Sigma_s}{2} + \nu \frac{\Sigma_f}{2}\right) \left(\psi_{+}(x,t) + \psi_{-}(x,t)\right).
    \end{split}
  \end{equation*}
  \begin{itemize}
  \item
    \textcolor{cadmiumgreen}{unknowns} : $\psi_{+}$ and $\psi_{-}$ : angular fluxes in direction $+1$ and $-1$
    \\
    \vspace*{0.2 cm}
  \item
    $\MCS = \Sigma_s + \Sigma_a + \Sigma_f$ (cross sections)
    \\
        \vspace*{0.2 cm}
  \item
    $\nu$ : average number of neutrons emitted per fission
    \end{itemize}
\end{frame}
\begin{frame}
  \frametitle{Fine propagator : The Monte Carlo algorithm}
  \vspace*{-0.2 cm}
  \invisible<1>{
  \begin{enumerate}
  \item
   \textcolor{cadmiumgreen}{\textbf{Sampling the initial guess}}
    \\
    \vspace*{0.1 cm}
    \textcolor{burntorange}{$\rightarrow$} Position of particles (direct inversion of cumulative, table lookup, rejection...)
    \\
    \vspace*{0.1 cm}
    \textcolor{burntorange}{$\rightarrow$} direction of particles.
    %% Two possibilities : $\omega_i=+1$ with probability $p^{+}$ or $\omega = -1$ with probability $p^{-}$.    
Select $\xi \sim \mathcal{U}\left(\left[0,1 \right] \right)$.
If $\xi \leq p^{+}$, $\omega_i = +{1}$.
Otherwise, $\omega_i = -{1}$.
\invisible<2>{
\item
  \textcolor{cadmiumgreen}{\textbf{Sampling the flights}}
  \\
  \vspace*{0.1 cm}
Probability of collision between $s > 0$ and $s+ds > 0$ is $\textcolor{midnightblue}{p(s)ds = \MCS e^{-\MCS s} ds}$.
The path is obtained by the direct inversion of the cumulative
\textcolor{midnightblue}{$s = -\frac{1}{\MCS} \ln(1 - \xi)$} with $\xi \sim \mathcal{U}\left(\left[0,1 \right] \right)$
\invisible<3>{
\item
  \textcolor{cadmiumgreen}{\textbf{Collision}}
  \\
  \vspace*{0.1 cm}
 $\xi_1 \sim \mathcal{U}\left(\left[0,1 \right] \right)$. If $\xi_1 \leq  \frac{\MCSS}{\MCS}$  \textcolor{midnightblue}{scattering event} $\Rightarrow$ sample a new direction and flight.
  If $ \frac{\MCSS}{\MCS} < \xi_1 \leq \frac{\MCSS}{\MCS} + \frac{\MCSA}{\MCS}$
   \textcolor{midnightblue}{absorption event} $\rightarrow$ the neutron is dead.
   \\
   If $\xi_1 > \frac{\MCSS}{\MCS} + \frac{\MCSA}{\MCS} $ \textcolor{midnightblue}{fission event}. The mother neutron is dead and $\overline{\nu}$ child neutrons are emitted.
New directions and flights have to be sampled for each child neutrons. 
\\
\vspace*{0.1 cm}
\invisible<4>{
\item
  \textcolor{cadmiumgreen}{\textbf{Monte Carlo computation}}
  \\
  \vspace{0.1 cm}
  Compute an approximation of $\int_{\Omega} \left(\psi_{+} + \psi_{-}\right)(x,t)\,\dx = \int_{\Omega} \Phi(x,t) \,\dx$
  \end{enumerate}
  \invisible<5>{
    }}}}}
\end{frame}
\begin{frame}
  \frametitle{Coarse propagator : A reaction-diffusion model}
  \begin{equation*}
    \begin{split}
  \frac{\partial \phi}{\partial t}(x,t) - \mathcal{D} \frac{\partial^2 \phi}{\partial x^2}(x,t) + \MCSA \phi(x,t) + (\nu - 1) \MCSF \phi(x,t) = 0 \quad & \text{in} \quad \Omega \times [0,T] \\
  \phi(x,0) = \phi^0(x) \quad & \text{in} \quad \Omega \\
  \phi(x,t) = 0 \quad & \text{on} \quad \partial \Omega \times ]0,T[
\end{split}
  \end{equation*}
  \textcolor{cadmiumgreen}{\textbf{Cell-centered finite volume method:}}
 a single constant value per cell: $\forall 1 \leq n \leq \Nt-1$ we let
\begin{equation*}
  {\bm \Phi}^{n} \egaldef \left(\phi_K^{n} \right)_{K \in \Th} \in \mathbb{R}^{\Ne} \quad \phi_K^n := \frac{1}{|K|} \int_{K}\phi^n(x)\,\dx
\end{equation*}
By integration over the element $K$ and using the Green's formula we obtain
\begin{equation*}
  \frac{|K|}{\Delta t_n} \phi_{K}^{n} + \mathcal{D} \sum_{\sigma \in \EK} \mathfrak{F}_{K,\sigma}^{n} -|\sigma| \frac{\phi_K^n}{d_{K \sigma}} + \MCSA \phi_{K}^{n} + (\nu-1) \MCSF \phi_{K}^{n} = Q_{K}^{n-1} \quad \forall K \in \Th.
\end{equation*}
\textcolor{midnightblue}{${\bm \Phi}^{n}$ is solution to a linear system of equations}
\end{frame}
%
\begin{frame}
  \frametitle{Numerical experiments}
  $\MCSA = \MCSF = 0$
  \\
  \vspace{0.2 cm}
  \begin{center}
    \textcolor{red}{$n=4$}
    \end{center}
  \begin{figure}
    \centering
\includegraphics[width = 0.48 \textwidth]{image/image_Boltzmann/exact_vs_hybrid_n=4}
\quad
\includegraphics[width = 0.48 \textwidth]{image/image_Boltzmann/Linf_error_n=4}
\end{figure}
\end{frame}
%
\begin{frame}
\begin{center}
  \textcolor{red}{$n=80$}
  \end{center}
\begin{figure}
    \centering
\includegraphics[width = 0.48 \textwidth]{image/image_Boltzmann/exact_vs_hybrid_n=80}
\quad
\includegraphics[width = 0.48 \textwidth]{image/image_Boltzmann/Linf_error_n=80}
\end{figure}
\begin{thebibliography}{10}
 \scriptsize{
 \bibitem{Dabaghi:Maday:Zoia:2021}
 {\sc J.~Dabaghi, Y.~Maday, A.~Zoia, {\em A hybrid parareal Monte-Carlo algorithm for the Boltzmann equation in neutronics}.
 \textcolor{black}{In preparation (2021)}}}
 \end{thebibliography}
  \end{frame}
%%~~~~~~~~~~~            ~~~~~~~~~~~~~
%%~~~~~~~~~~~ CONCLUSION ~~~~~~~~~~~~~
%%~~~~~~~~~~~            ~~~~~~~~~~~~~

\section{Conclusion}
\begin{frame}
\frametitle{Conclusion}
\begin{itemize}
\item
We devised for the diffusion equation a hybrid parareal algorithm.
\vspace{0.3 cm}
\item Our approach reduces the CPU time of a Monte-Carlo simulation.
\end{itemize}
\vspace{0.5 cm}
\textcolor{red}{\textbf{Ongoing work:}}
\begin{itemize}
\item Extension to the Boltzmann equation in neutronics with absorption and fission
\end{itemize}
\vspace{0.5 cm}


\end{frame}

\begin{frame}
\centering
\vspace*{1 cm}
\Huge Thank you for your attention!
\vspace*{2 cm}
\begin{figure}
\centering
\includegraphics[scale=1]{image/smiley}
\end{figure}
\end{frame}
%

\bibliographystyle{plain}
\bibliography{diphasique_biblio}
\end{document}



